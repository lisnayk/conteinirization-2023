# Лекція №3. Docker Storage

У Docker є кілька типів зберігання, які використовуються для роботи з даними в контейнерах (рис 4.1). Основні типи включають:
- **Volumes** - найпоширеніший спосіб зберігання даних у Docker. Томи керуються Docker і зберігаються в спеціальній директорії на хості, що робить їх незалежними від життєвого циклу контейнерів. Дозволяють зберігати дані між перезапусками або знищенням контейнерів. Вони використовуються для зберігання даних баз даних або конфігурацій, які потребують довготривалого зберігання.
- **Bind mounts** -  тип зберігання, де ви вказуєте конкретну директорію на вашому хості, яку Docker монтує всередину контейнера. У порівнянні з томами, це забезпечує більше контролю над тим, де зберігаються дані. Використовується для доступу до файлів на хості, що корисно при розробці, коли необхідно взаємодіяти з локальними файлами.
- **tmpfs mounts** - тимчасове зберігання, яке використовується лише під час роботи контейнера. Дані зберігаються в оперативній пам'яті та видаляються після завершення роботи контейнера й виикористовується для зберігання тимчасових даних, наприклад, при роботі з кешем або даними, які не потребують довготривалого зберігання.

![img.png](/assets/img.png)

Рисунок 4.1 - Типи зберігання в Docker

Незалежно від того, який тип монтування ви виберете, дані виглядатимуть однаково всередині контейнера. Він доступний або як каталог, або як окремий файл у файловій системі контейнера.

### Docker volumes

**Docker Volumes** — це зручний і продуктивний спосіб управління даними, що допомагає їх зберігати між перезапусками контейнерів.
Існують два типи volumes:
- **Анонімні** - томи, які створюються без явної вказівки імені. Вони автоматично видаляються після видалення контейнера, якщо не використовуються іншими контейнерами.
- **Іменовані** - томи, які явно мають назву і можуть бути повторно використані в інших контейнерах. Іменованими томами легко керувати, оскільки є вожливість звертатися до них за іменем.

Для керування іменованими томами використовуются наступні консольні команди:

| **Команда**     | **Опис**                                                    |
|-----------------|-------------------------------------------------------------|
| `create`        | Створення тому                                               |
| `inspect`       | Виведення детальної інформації про один або кілька томів     |
| `ls`            | Виведення списку томів                                       |
| `prune`         | Видалення невикористовуваних локальних томів                 |
| `rm`            | Видалення одного або кількох томів                           |

Напрриклад, створення іменованого тому виконується командою:
```shell
docker volume create mysql-data
docker volume inspect mysql-data
[
    {
        "CreatedAt": "2024-09-29T05:24:49Z",
        "Driver": "local",
        "Labels": null,
        "Mountpoint": "/var/lib/docker/volumes/mysql-data/_data",
        "Name": "mysql-data",
        "Options": null,
        "Scope": "local"
    }
]
```

### Bind mounts

Bind mounts існує з перших днів Docker та маэ обмежену функціональність порівняно з томами. Коли використовуєтся Bind mounts, файл або каталог на головній машині монтується в контейнер.
На файл або каталог посилається його абсолютний шлях на головній машині.
Файл або каталог не обов’язково повинні існувати на хості Docker. Він створюється на вимогу, якщо його ще немає. Bind mounts дуже продуктивне, але воно залежить від файлової системи хост-машини, яка має певну структуру каталогів.
Якщо каталог монтуэться до непорожнього каталогу в контейнері, існуючий вміст каталогу буде приховано монтуванням прив’язки.
Це може бути корисним, наприклад, коли ви хочете протестувати нову версію програми без створення нового образу. Однак це також може бути несподіваним, і така поведінка відрізняється від поведінки томів.

### Параметри для монтування -v та --mount

Для використанння томів в Docker можна використовувати параметри команди `run` -v (--volume) або --mount. Обидва параметри використовуються для монтування томів, але мають різний синтаксис та функціональність.
Загалом, --mount більш відвертий і багатослівний. Найбільша різниця між ними полягає в тому, що -v синтаксис об’єднує всі параметри в одному полі, тоді як --mount синтаксис розділяє їх.

Аргумент -v або --volume - складається з трьох полів, розділених двокрапкою (:). Поля мають бути в правильному порядку, і значення кожного поля не є очевидним.

- У випадку **Bind mounts** перше поле — це шлях до файлу або каталогу на головній машині, або джерело а у разі іменованих томів перше поле — це ім’я тому, яке є унікальним на певній головній машині. Для анонімних томів перше поле опускається.
- Друге поле — це шлях, куди змонтовано файл або каталог у контейнері.
- Третє поле є необов’язковим і являє собою список параметрів, розділених комами, наприклад ro (readonly).

Аргументи --mount - складається з кількох пар ключ-значення, розділених комами, кожна з яких складається з <key>=<value> кортежу.
Синтаксис --mount більш детальний, ніж -v або --volume, але порядок ключів не є значущим, і значення прапора легше зрозуміти.
Найнеохідніші ключі --mount включають:
- `type` може приймати значення `bind`, `volume` або `tmpfs`.
- `source` або `src` - шлях до файлу або каталогу на хості, ім’я тому для іменованих томів або залишаэться пустим для анонімних томів.
- `destination`, `dst` або `target` - шлях монтування або файл або каталог у контейнері.

## Відповідні випадки для використання томів

Томи є рекомендованим способом зберігання даних у контейнерах та службах Docker. Деякі сценарії для їх використання включають:

- Спільне використання даних між кількома контейнерами. Якщо том не створено явно, він створюється автоматично при першому підключенні до контейнера. Томи залишаються існувати навіть після завершення роботи контейнера. Кілька контейнерів можуть одночасно монтувати один і той самий том в режимі читання-запису або лише читання.

- Коли структура директорій або файлів на хості Docker не гарантована. Томи дозволяють відокремити конфігурацію хоста Docker від контейнера.

- Збереження даних контейнера на віддаленому хості або в хмарі. Ви можете зберігати дані не локально, а в хмарі або на віддаленому сервері.

- Резервне копіювання, відновлення або міграція даних. Томи зручні для переміщення даних між різними хостами Docker. Можна зупинити контейнери, які використовують том, і зробити резервну копію каталогу тома.

- Покращення продуктивності вводу-виводу. На Docker Desktop томи зберігаються у Linux-віртуальній машині, що зменшує затримку та збільшує пропускну здатність при читанні та запису.

- Гарантії поведінки файлової системи. Наприклад, для роботи бази даних важливо мати повний контроль над процесами запису для забезпечення збереження транзакцій.

## Відповідні випадки для використання bind mounts

- Загалом, рекомендується використовувати томи, але bind mounts підходять для таких сценаріїв:

- Спільне використання файлів конфігурації з хоста на контейнер. Docker використовує цей механізм для підключення файлу /etc/resolv.conf для налаштування DNS.

- Спільне використання вихідного коду або артефактів між середовищем розробки і контейнером. Наприклад, можна змонтувати директорію з вихідним кодом і кожного разу при зміні файлів вони будуть доступні в контейнері.

- Коли структура файлів або директорій на хості Docker гарантовано узгоджена з потребами контейнера.

## Випадки для tmpfs mounts

tmpfs mounts краще використовувати в ситуаціях, коли ви не хочете, щоб дані зберігались на хості або всередині контейнера, наприклад, з міркувань безпеки або для захисту продуктивності при роботі з великими обсягами тимчасових даних.

## Поради щодо використання зв’язаних монтувань або томів

- Якщо ви монтуєте порожній том у каталог у контейнері, у якому існують файли чи каталоги, ці файли чи каталоги поширюються (копіюються) у том. Так само, якщо ви запускаєте контейнер і вказуєте том, якого ще не існує, для вас буде створено порожній том. Це хороший спосіб попереднього заповнення даними, які потрібні іншому контейнеру.

- Якщо ви монтуєте прив’язане монтування або непорожній том до каталогу в контейнері, у якому існують деякі файли чи каталоги, ці файли чи каталоги будуть закриті під час монтування, так само як якщо б ви зберегли файли на /mntхості Linux, а потім змонтували USB-накопичувач у /mnt. Вміст /mntбуде закритий вмістом USB-накопичувача, доки USB-накопичувач не буде відключено. Приховані файли не видаляються та не змінюються, але вони недоступні під час монтування прив’язки або тому.

